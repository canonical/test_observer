project: test-observer-charm-tests
kill-timeout: 90m
workers: 1

environment:
  CI: "$(HOST: echo $CI)"
  CONCIERGE_JUJU_CHANNEL/juju_3_6: 3.6/stable

backends:
  lxd:
    type: adhoc
    allocate: |
      BASE="${BASE:-jammy}"
      VM_NAME="${VM_NAME:-ubuntu-${BASE}-${RANDOM}}"
      DISK="${DISK:-20}"
      CPU="${CPU:-4}"
      MEM="${MEM:-8}"

      cloud_config="$(mktemp)"
      sed "s|SPREAD_PASSWORD|$SPREAD_PASSWORD|g" spread/cloud-config.yaml > "$cloud_config"

      if lxc list --format csv -c n |  grep -q "${VM_NAME}"; then
        echo "\"${VM_NAME}\" already exists -> skipping rest of allocation."
      else
        echo "No \"${VM_NAME}\" present -> launching"
        lxc launch --vm \
          "ubuntu:${BASE}" \
          "${VM_NAME}" \
          -c user.user-data="$(cat "$cloud_config")" \
          -c limits.cpu="${CPU}" \
          -c limits.memory="${MEM}GiB" \
          -d root,size="${DISK}GiB"
      fi

      # Wait for the spread user
      while ! lxc exec "${VM_NAME}" -- id -u spread &>/dev/null; do sleep 0.5; done

      rm "$cloud_config"

      # Set the instance address for spread
      ADDRESS "$(lxc ls -f csv | grep "${VM_NAME}" | cut -d"," -f3 | cut -d" " -f1)"
    discard: |
      instance_name="$(lxc ls -f csv | grep $SPREAD_SYSTEM_ADDRESS | cut -f1 -d",")"
      lxc delete -f $instance_name

    systems:
      - ubuntu-22.04:
          username: spread
          workers: 1

  github-ci:
    type: adhoc
    manual: true
    allocate: |
      sudo sed -i "s|#PasswordAuthentication yes|PasswordAuthentication yes|g" /etc/ssh/sshd_config
      sudo sed -i "s|KbdInteractiveAuthentication no|KbdInteractiveAuthentication yes|g" /etc/ssh/sshd_config
      sudo rm -f /etc/ssh/sshd_config.d/60-cloudimg-settings.conf
      sudo systemctl daemon-reload
      sudo systemctl restart ssh

      sudo useradd spread -s /bin/bash -m || true
      echo "spread:$SPREAD_PASSWORD" | sudo chpasswd || true
      echo 'spread ALL=(ALL) NOPASSWD:ALL ' | sudo tee /etc/sudoers.d/99-spread-user || true

      ADDRESS "127.0.0.1"
    discard: |
      sudo userdel -f -r spread || true
      sudo rm -f /etc/sudoers.d/99-spread-user

    systems:
      - ubuntu-22.04:
          username: spread
          workers: 1

suites:
  spread/:
    summary: Spread tests

exclude:
  - .coverage
  - .git
  - .github
  - .pytest_cache
  - .ruff_cache
  - .tox
  - .venv

# this needs to be under /root because spread executes the test scripts
# as root, which means that juju can only see files in root's
# home directory due to snap confinement.
path: /root/proj

prepare: |
  snap refresh --hold
  if systemctl is-active unattended-upgrades.service; then
    systemctl stop unattended-upgrades.service
    systemctl mask unattended-upgrades.service
  fi

  snap install --classic concierge
  concierge prepare --trace -p microk8s

  charmcraft pack --destructive-mode --verbose -p backend/charm
  chown $(id -u):$(id -g) test-observer-api_ubuntu-22.04-amd64.charm
  mv test-observer-api_ubuntu-22.04-amd64.charm backend/charm/test-observer-api_ubuntu-22.04-amd64.charm

  charmcraft pack --destructive-mode --verbose -p frontend/charm
  chown $(id -u):$(id -g) test-observer-frontend_ubuntu-22.04-amd64.charm
  mv test-observer-frontend_ubuntu-22.04-amd64.charm frontend/charm/test-observer-frontend_ubuntu-22.04-amd64.charm

restore: |
  if [[ -z "${CI:-}" ]]; then
    concierge restore --trace
    
    apt autoremove -y --purge
    rm -Rf "$SPREAD_PATH"
    mkdir -p "$SPREAD_PATH"
  fi
