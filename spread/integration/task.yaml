summary: Run the charm integration test

execute: |
  backend_oci_image="$(cat "${SPREAD_PATH}"/backend/charm/charmcraft.yaml | yq '.resources.api-image.upstream-source')"
  frontend_oci_image="$(cat "${SPREAD_PATH}"/frontend/charm/charmcraft.yaml | yq '.resources.frontend-image.upstream-source')"

  juju deploy "${SPREAD_PATH}"/backend/charm/*.charm backend \
    --config hostname=test-observer-api.test \
    --config sessions_secret="$(openssl rand -base64 32)" \
    --resource api-image="${backend_oci_image}"

  juju deploy redis-k8s --channel=latest/edge --revision=27 redis
  juju relate backend redis

  juju deploy postgresql-k8s --channel=14/stable --revision=281 db
  juju trust db --scope=cluster
  juju relate backend db

  juju deploy "${SPREAD_PATH}"/frontend/charm/*.charm frontend \
    --config hostname=test-observer-frontend.test \
    --config test-observer-api-scheme='http://' \
    --resource frontend-image="${frontend_oci_image}"
  juju relate backend frontend

  if ! juju wait-for application backend --timeout=5m; then
    microk8s config > kube-config
    pipx run --spec git+https://github.com/canonical/juju-k8s-crashdump.git juju-k8s-crashdump \
      ./kube-config concierge-microk8s -o integration-juju-k8s-crashdump.tar.gz
    exit 1
  fi

  if ! juju wait-for application frontend --timeout=5m; then
    microk8s config > kube-config
    pipx run --spec git+https://github.com/canonical/juju-k8s-crashdump.git juju-k8s-crashdump \
      ./kube-config concierge-microk8s -o integration-juju-k8s-crashdump.tar.gz
    exit 1
  fi

  juju run backend/leader add-user launchpad-email=solutions-qa@lists.canonical.com

  PGPASSWORD=$(juju run db/leader get-password | grep password | awk '{print $2;}')
  PGHOST=$(juju show-unit db/0 | grep address | tail -n 1 | awk '{print $2;}')
  PGUSER=operator
  PGDATABASE=test_observer_db
  juju ssh --container postgresql db/leader \
    "PGPASSWORD=$PGPASSWORD PGHOST=$PGHOST PGUSER=$PGUSER PGDATABASE=$PGDATABASE psql -c \"select launchpad_handle from app_user where email='solutions-qa@lists.canonical.com'\"" \
    | grep oil-ci-bot

artifacts:
  - integration-juju-k8s-crashdump.tar.gz

restore: |
  if [[ -z "${CI:-}" ]]; then
    # The testing model is created by concierge
    juju destroy-model testing --destroy-storage --force --no-prompt --no-wait
    juju add-model testing
  fi
