apiVersion: skaffold/v4beta4
kind: Config
metadata:
  name: test-observer-frontend
build:
  artifacts:
    - image: localhost:32000/test-observer-api
      docker:
        dockerfile: Dockerfile
      # Sync these files to avoid rebuilding images
      sync:
        manual:
          - dest: "src/"
            src: "src/**"
            strip: "src/"
          - dest: "tests/"
            src: "tests/**"
            strip: "tests/"
          - dest: "alembic/"
            src: "alembic/**"
            strip: "alembic/"
  # Use microk8s registry
  insecureRegistries:
    - localhost:32000
deploy:
  kubeContext: microk8s
  kubectl:
    hooks:
      after:
        - container:
            # Run database migrations
            command: ["sh", "-c", "alembic upgrade head"]
            podName: test-observer-api*
