name: test-observer-api
type: charm
description: |
  Test Observer API server
summary: |
  API and dashboard to observe the status of artifact (snaps, debs, etc) test status
assumes:
  - juju >= 2.9
  - k8s-api

requires:
  database:
    interface: postgresql_client
    limit: 1
  nginx-route:
    interface: nginx-route
  redis:
    interface: redis

provides:
  test-observer-rest-api:
    interface: http
    scope: global

resources:
  api-image:
    type: oci-image
    description: OCI image from GitHub Container Repository
    upstream-source: ghcr.io/canonical/test_observer/api:main

base: ubuntu@24.04
platforms:
  amd64:

parts:
  test-observer-api:
    source: .
    plugin: charm

config:
  options:
    port:
      default: 30000
      description: The port to listen on for incoming HTTP requests.
      type: int

    hostname:
      default: test-observer-api
      description: Public hostname for the service.
      type: string

    sentry_dsn:
      default: ""
      description: value for SENTRY_DSN that is used to send errors to sentry
      type: string

    admin_client_id:
      type: string
      description: Admin API client ID

    admin_client_secret:
      type: string
      description: Admin API client secret

    token_signing_secret:
      type: string
      description: Secret used to sign JWT tokens

    token_signing_algorithm:
      type: string
      description: Algorithm used to sign JWT tokens
      default: HS256

    token_expiry:
      type: string
      description: Expiry period for JWT tokens in minutes
      default: "60"

containers:
  api:
    resource: api-image
  celery:
    resource: api-image

actions:
  delete-artefact:
    description: Deletes an Artefact together with it's builds, test executions and test results
    params:
      artefact-id:
        description: "The id of the artefact to be deleted"
        type: integer
    required: [artefact-id]

  add-user:
    description: Adds a launchpad user to the group of users that can review artefacts
    params:
      launchpad-email:
        description: "An email address registered in launchpad"
        type: string
    required: [launchpad-email]

  change-assignee:
    description: Changes the user assigned to review a particular artefact
    params:
      artefact-id:
        description: "The id of the artefact whose assignee should be changed"
        type: integer
      user-id:
        description: "The id of the user that should be assigned to review this artefact"
        type: integer
    required: [artefact-id, user-id]
